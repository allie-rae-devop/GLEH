version: '3.8'

################################################################################
# GLEH (Gammons Landing Educational Hub) - Docker Compose Configuration
################################################################################
# Production-ready multi-container setup for GLEH
#
# Services:
#   - web: Flask application server
#   - db: PostgreSQL database
#   - nginx: Reverse proxy and static file server
#
# Usage:
#   docker-compose up -d           # Start all services
#   docker-compose down            # Stop all services
#   docker-compose logs -f         # View logs
#   docker-compose ps              # List running containers
#
# Environment:
#   Copy .env.example to .env and configure values
################################################################################

services:
  # =========================================================================
  # DATABASE SERVICE
  # =========================================================================
  db:
    image: postgres:15-alpine
    container_name: gleh-postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-gleh_db}
      POSTGRES_USER: ${DB_USER:-gleh_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      # Database data persistence
      - postgres_data:/var/lib/postgresql/data
      # Optional: SQL initialization scripts
      # - ./db_init:/docker-entrypoint-initdb.d
    networks:
      - gleh_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-gleh_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # =========================================================================
  # FLASK APPLICATION SERVICE
  # =========================================================================
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        PYTHON_VERSION: "3.11"
    container_name: gleh-web
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      calibre-web:
        condition: service_started
    environment:
      # Flask Configuration
      FLASK_APP: src/app.py
      FLASK_ENV: ${FLASK_ENV:-production}
      FLASK_DEBUG: "0"
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 5000

      # Database Configuration
      DATABASE_URL: postgresql://${DB_USER:-gleh_user}:${DB_PASSWORD:-change_me_in_production}@db:5432/${DB_NAME:-gleh_db}

      # Storage Configuration - MinIO Object Storage
      STORAGE_TYPE: ${STORAGE_TYPE:-minio}

      # MinIO Configuration
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-gleh-storage}
      MINIO_SECURE: ${MINIO_SECURE:-false}

      # Calibre-Web Integration (Docker network name)
      CALIBRE_WEB_URL: ${CALIBRE_WEB_URL:-http://calibre-web:8083}

      # Security
      SECRET_KEY: ${SECRET_KEY:-change_me_in_production}
      SESSION_COOKIE_SECURE: "true"
      SESSION_COOKIE_HTTPONLY: "true"
      SESSION_COOKIE_SAMESITE: "Lax"

      # Legacy Samba Configuration (DEPRECATED - for private fork only)
      # SAMBA_HOST: ${SAMBA_HOST}
      # SAMBA_SHARE: ${SAMBA_SHARE}
      # SAMBA_USERNAME: ${SAMBA_USERNAME}
      # SAMBA_PASSWORD: ${SAMBA_PASSWORD}
      # SAMBA_MOUNT_PATH: ${SAMBA_MOUNT_PATH:-/mnt/gleh-data}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_JSON_FORMAT: "true"

    ports:
      - "127.0.0.1:5000:5000"  # Internal only - use Nginx for external access
    volumes:
      # No local file mounts needed - all storage handled by MinIO
      # Legacy: ${CONTENT_DIR:-../data/gleh}:/data/gleh:rw (REMOVED)
      - app_logs:/app/logs:rw

    networks:
      - gleh_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

  # =========================================================================
  # MINIO OBJECT STORAGE SERVICE
  # =========================================================================
  minio:
    image: minio/minio:latest
    container_name: gleh-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:9001}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"      # MinIO API
      - "${MINIO_CONSOLE_PORT:-9001}:9001"  # MinIO Web Console
    volumes:
      - minio_data:/data
    networks:
      - gleh_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # =========================================================================
  # CALIBRE - EBOOK LIBRARY MANAGEMENT
  # =========================================================================
  calibre:
    image: lscr.io/linuxserver/calibre:latest
    container_name: gleh-calibre
    environment:
      - PUID=${CALIBRE_PUID:-1024}
      - PGID=${CALIBRE_PGID:-100}
      - TZ=${TZ:-America/Los_Angeles}
      - PASSWORD=${CALIBRE_PASSWORD:-Camel100}
    ports:
      - "${CALIBRE_WEB_PORT:-8080}:8080"       # Calibre web interface
      - "${CALIBRE_SERVER_PORT:-8081}:8081"    # Calibre content server
    volumes:
      - calibre_library:/config
    networks:
      - gleh_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # =========================================================================
  # CALIBRE-WEB - EBOOK WEB INTERFACE & OPDS
  # =========================================================================
  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: gleh-calibre-web
    depends_on:
      - calibre
    environment:
      - PUID=${CALIBRE_WEB_PUID:-1024}
      - PGID=${CALIBRE_WEB_PGID:-100}
      - TZ=${TZ:-America/Los_Angeles}
      - DOCKER_MODS=linuxserver/mods:universal-calibre
      - OAUTHLIB_RELAX_TOKEN_SCOPE=1
    ports:
      - "${CALIBRE_WEB_PORT:-8083}:8083"
    volumes:
      - calibre_library:/config      # Shared with Calibre for metadata.db
      - calibre_library:/books        # Shared library location
    networks:
      - gleh_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # =========================================================================
  # NGINX REVERSE PROXY SERVICE
  # =========================================================================
  nginx:
    image: nginx:alpine
    container_name: gleh-nginx
    depends_on:
      - web
    ports:
      - "0.0.0.0:${NGINX_PORT:-80}:80"
      - "0.0.0.0:${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ../static:/app/static:ro
      # Optional: SSL certificates (uncomment for HTTPS)
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - gleh_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

################################################################################
# VOLUMES - Persistent Data Storage
################################################################################
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DB_DATA_DIR:-../data/postgres}

  minio_data:
    driver: local
    name: gleh-minio-data

  app_logs:
    driver: local
    name: gleh-app-logs

  calibre_library:
    driver: local
    name: gleh-calibre-library
    # This volume stores the Calibre library database and ebooks
    # Shared between Calibre (writes) and Calibre-Web (reads)

################################################################################
# NETWORKS - Inter-service Communication
################################################################################
networks:
  gleh_network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500

################################################################################
# NOTES FOR CONFIGURATION
################################################################################
#
# LOCAL DEVELOPMENT:
#   - Copy .env.example to .env in the docker directory
#   - Run: docker-compose up
#   - Access Flask app at http://localhost
#   - Access MinIO console at http://localhost:9001 (minioadmin/minioadmin)
#
# PRODUCTION DEPLOYMENT:
#   - Set FLASK_ENV=production
#   - Set SECRET_KEY to a strong random value
#   - Set MINIO_ROOT_USER and MINIO_ROOT_PASSWORD to secure values
#   - Configure SSL certificates for HTTPS (nginx and MinIO)
#   - Use environment variables (not .env file) for secrets
#   - Consider enabling MinIO encryption and versioning
#
# MINIO OBJECT STORAGE:
#   - Buckets are created automatically by src/minio_client.py on startup
#   - Default bucket: gleh-storage
#   - Subfolders: courses/, uploads/
#   - Web console: http://localhost:9001
#   - API endpoint: http://minio:9000 (internal Docker network)
#
# CALIBRE + CALIBRE-WEB:
#   - Calibre: Ebook library management (http://localhost:8080)
#   - Calibre-Web: Web interface + OPDS API (http://localhost:8083)
#   - Both share the calibre_library volume
#   - Calibre manages metadata.db, Calibre-Web reads it
#   - GLEH Flask app connects to Calibre-Web OPDS feed
#
# LEGACY SAMBA INTEGRATION (DEPRECATED - Private fork only):
#   - Samba configuration has been removed for public 1.0 release
#   - All file storage now handled by MinIO object storage
#   - For private fork: uncomment Samba environment variables
#
################################################################################
