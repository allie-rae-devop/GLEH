version: '3.8'

################################################################################
# GLEH (Gammons Landing Educational Hub) - Docker Compose Configuration
################################################################################
# Production-ready multi-container setup for GLEH
#
# Services:
#   - web: Flask application server
#   - db: PostgreSQL database
#   - nginx: Reverse proxy and static file server
#
# Usage:
#   docker-compose up -d           # Start all services
#   docker-compose down            # Stop all services
#   docker-compose logs -f         # View logs
#   docker-compose ps              # List running containers
#
# Environment:
#   Copy .env.example to .env and configure values
################################################################################

services:
  # =========================================================================
  # DATABASE SERVICE
  # =========================================================================
  db:
    image: postgres:15-alpine
    container_name: edu-postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-edu_db}
      POSTGRES_USER: ${DB_USER:-edu_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      # Database data persistence
      - postgres_data:/var/lib/postgresql/data
      # Optional: SQL initialization scripts
      # - ./db_init:/docker-entrypoint-initdb.d
    networks:
      - edu_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-edu_user} -d ${DB_NAME:-edu_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # =========================================================================
  # FLASK APPLICATION SERVICE
  # =========================================================================
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        PYTHON_VERSION: "3.11"
    container_name: edu-web
    depends_on:
      db:
        condition: service_started
      calibre-web:
        condition: service_started
    environment:
      # Flask Configuration
      FLASK_APP: src/app.py
      FLASK_ENV: ${FLASK_ENV:-production}
      FLASK_DEBUG: "0"
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 5000

      # Database Configuration
      DATABASE_URL: postgresql://${DB_USER:-edu_user}:${DB_PASSWORD:-change_me_in_production}@db:5432/${DB_NAME:-edu_db}

      # Calibre-Web Integration
      # Internal URL for API calls (Docker network)
      CALIBRE_WEB_URL: ${CALIBRE_WEB_URL:-http://calibre-web:8083}
      # External URL for browser access (covers and reader)
      CALIBRE_WEB_EXTERNAL_URL: ${CALIBRE_WEB_EXTERNAL_URL:-http://localhost:8083}

      # Security
      SECRET_KEY: ${SECRET_KEY:-change_me_in_production}
      SESSION_COOKIE_SECURE: "true"
      SESSION_COOKIE_HTTPONLY: "true"
      SESSION_COOKIE_SAMESITE: "Lax"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_JSON_FORMAT: "true"

    ports:
      - "127.0.0.1:5000:5000"  # Internal only - use Nginx for external access
    volumes:
      # Course materials served directly by nginx
      - courses_data:/app/data/courses:ro
      # Application logs
      - app_logs:/app/logs:rw

    networks:
      - edu_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

  # =========================================================================
  # CALIBRE - EBOOK LIBRARY MANAGEMENT
  # =========================================================================
  calibre:
    image: lscr.io/linuxserver/calibre:latest
    container_name: edu-calibre
    environment:
      - PUID=${CALIBRE_PUID:-1024}
      - PGID=${CALIBRE_PGID:-100}
      - TZ=${TZ:-America/Los_Angeles}
      - PASSWORD=${CALIBRE_PASSWORD:-changeme}
    ports:
      - "${CALIBRE_PORT:-8080}:8080"           # Calibre web interface
      - "${CALIBRE_SERVER_PORT:-8081}:8081"    # Calibre content server
    volumes:
      - calibre_library:/config
    networks:
      - edu_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # =========================================================================
  # CALIBRE-WEB - EBOOK WEB INTERFACE & OPDS
  # =========================================================================
  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: edu-calibre-web
    depends_on:
      - calibre
    environment:
      - PUID=${CALIBRE_WEB_PUID:-1024}
      - PGID=${CALIBRE_WEB_PGID:-100}
      - TZ=${TZ:-America/Los_Angeles}
      - DOCKER_MODS=linuxserver/mods:universal-calibre
      - OAUTHLIB_RELAX_TOKEN_SCOPE=1
    ports:
      - "${CALIBRE_WEB_PORT:-8083}:8083"
    volumes:
      - calibre_library:/config      # Shared with Calibre for metadata.db
      - calibre_library:/books        # Shared library location
    networks:
      - edu_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # =========================================================================
  # NGINX REVERSE PROXY SERVICE
  # =========================================================================
  nginx:
    image: nginx:alpine
    container_name: edu-nginx
    depends_on:
      - web
    ports:
      - "0.0.0.0:${NGINX_PORT:-3080}:80"
      - "0.0.0.0:${NGINX_HTTPS_PORT:-3443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ../static:/app/static:ro
      - courses_data:/app/data/courses:ro
      # Optional: SSL certificates (uncomment for HTTPS)
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - edu_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

################################################################################
# VOLUMES - Persistent Data Storage
################################################################################
volumes:
  postgres_data:
    driver: local
    name: edu-postgres-data
    # PostgreSQL database storage

  app_logs:
    driver: local
    name: edu-app-logs

  calibre_library:
    driver: local
    name: edu-calibre-library
    # This volume stores the Calibre library database and ebooks
    # Shared between Calibre (writes) and Calibre-Web (reads)

  courses_data:
    driver: local
    name: edu-courses
    # This volume stores MIT OCW and other course content
    # Upload via SFTP or Docker Desktop volume access
    # Served directly by nginx for fast static file delivery

################################################################################
# NETWORKS - Inter-service Communication
################################################################################
networks:
  edu_network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500