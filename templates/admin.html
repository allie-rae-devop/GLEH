<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Control Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <style>
        [data-bs-theme="dark"] {
            --bs-body-bg: #121212;
            --bs-tertiary-bg: #1a1a1a;
            --bs-border-color: #2a2a2a;
        }

        .nav-tabs .nav-link {
            color: #888;
            border: none;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: #fff;
            border-bottom-color: #0d6efd;
            background-color: transparent;
        }

        .nav-tabs .nav-link:hover {
            color: #ccc;
        }

        .stat-card {
            background: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d6efd;
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
        }

        .progress-log {
            background: #0a0a0a;
            border: 1px solid var(--bs-border-color);
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .progress-log .log-line {
            margin: 5px 0;
            color: #aaa;
        }

        .progress-log .log-success {
            color: #28a745;
        }

        .progress-log .log-error {
            color: #dc3545;
        }

        .progress-log .log-info {
            color: #17a2b8;
        }

        .btn-action {
            min-width: 150px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
        }

        .status-running {
            background-color: #28a745;
            color: white;
        }

        .status-stopped {
            background-color: #dc3545;
            color: white;
        }

        .env-config-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .env-config-input {
            background: #1a1a1a;
            border: 1px solid var(--bs-border-color);
            color: #fff;
        }

        .drag-drop-area {
            border: 2px dashed var(--bs-border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: var(--bs-tertiary-bg);
            cursor: pointer;
            transition: all 0.3s;
        }

        .drag-drop-area:hover {
            border-color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
        }

        .drag-drop-area.dragover {
            border-color: #0d6efd;
            background: rgba(13, 110, 253, 0.2);
        }
    </style>
</head>
<body class="bg-body-tertiary">

    <header class="py-3 border-bottom" style="background-color: var(--bs-tertiary-bg);">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('index') }}" class="text-decoration-none text-body d-flex align-items-center">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="GLEH Logo" style="max-height: 60px; max-width: 100%;">
                </a>
                <h1 class="mb-0 fs-3 ms-3">Admin Control Panel</h1>
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-light">Back to Home</a>
        </div>
    </header>

    <main class="container-fluid my-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab">Courses</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="diagnostics-tab" data-bs-toggle="tab" data-bs-target="#diagnostics" type="button" role="tab">Diagnostics</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">About</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">

            <!-- DASHBOARD TAB -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-courses">0</div>
                            <div class="stat-label">Courses</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-textbooks">0</div>
                            <div class="stat-label">Textbooks (Calibre-Web)</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-users">0</div>
                            <div class="stat-label">Users</div>
                        </div>
                    </div>
                </div>

                <!-- Service Links -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Quick Access</h5>
                        <div class="d-flex gap-2">
                            <a href="http://localhost:8080" target="_blank" class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> Calibre Desktop (Port 8080)
                            </a>
                            <a href="http://localhost:8083" target="_blank" class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> Calibre-Web (Port 8083)
                            </a>
                            <button class="btn btn-secondary" onclick="switchToTab('courses')">Manage Courses</button>
                            <button class="btn btn-secondary" onclick="switchToTab('diagnostics')">Diagnostics</button>
                        </div>
                    </div>
                </div>

                <!-- Environment Configuration -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Environment Configuration</h5>
                        <p class="text-muted">Manage .env file variables. Warning: Changes require server restart.</p>
                        <button class="btn btn-info mb-3" onclick="loadEnvConfig()">Load Configuration</button>
                        <button class="btn btn-success mb-3" onclick="saveEnvConfig()">Save Changes</button>

                        <div class="env-config-table">
                            <table class="table table-striped table-hover" id="env-config-table">
                                <thead>
                                    <tr>
                                        <th>Variable</th>
                                        <th>Value</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="env-config-tbody">
                                    <tr><td colspan="3" class="text-center text-muted">Click "Load Configuration" to view</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addEnvVariable()">Add New Variable</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COURSES TAB -->
            <div class="tab-pane fade" id="courses" role="tabpanel">
                <div class="mb-4">
                    <h5>Course Upload</h5>
                    <div class="drag-drop-area" id="course-upload-area">
                        <p class="mb-2"><strong>Drag & Drop Course Files Here</strong></p>
                        <p class="text-muted">or click to browse (supports .zip files)</p>
                        <input type="file" id="course-file-input" accept=".zip" style="display: none;">
                    </div>
                    <div id="upload-progress" class="mt-3" style="display:none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" id="upload-progress-bar">0%</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5>Bulk Operations</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-action" onclick="scanCourses()">Scan Course Directory</button>
                        <button class="btn btn-warning btn-action" onclick="generateThumbnails()">Generate Thumbnails</button>
                        <button class="btn btn-info btn-action" onclick="autoCategorize()">Auto-Categorize</button>
                    </div>
                </div>

                <div id="course-progress" class="progress-log" style="display:none;">
                    <div id="course-log"></div>
                </div>

                <h5 class="mt-4">Courses Library</h5>
                <button class="btn btn-sm btn-info mb-3" onclick="loadCoursesTable()">Refresh</button>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="courses-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Thumbnail</th>
                                <th>Categories</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="courses-tbody">
                            <tr><td colspan="4" class="text-center text-muted">Click "Scan Course Directory" or "Refresh" to load</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- DIAGNOSTICS TAB -->
            <div class="tab-pane fade" id="diagnostics" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>System Status</h5>
                        <div class="stat-card text-start">
                            <p><strong>Server:</strong> <span id="diag-server-status" class="status-badge status-running">Running</span></p>
                            <p><strong>Database:</strong> <span id="diag-db-status">--</span></p>
                            <p><strong>Courses Volume:</strong> <span id="diag-volume-status">--</span></p>
                            <p><strong>Courses Directory:</strong> <span id="diag-courses-dir">--</span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Server Control</h5>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-warning btn-action" onclick="restartServer()">Restart Server</button>
                        </div>
                        <p class="text-muted mt-2"><small>Note: Server restart requires docker-compose restart</small></p>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Maintenance Scripts</h5>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-info btn-action" onclick="runScript('init_database.py')">Initialize Database</button>
                            <button class="btn btn-info btn-action" onclick="runScript('import_courses_from_volume.py')">Import Courses from Volume</button>
                        </div>
                        <div id="script-output" class="progress-log mt-3" style="display:none;">
                            <div id="script-log"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Self-Healing Diagnostics</h5>
                        <button class="btn btn-success mb-3" onclick="runSelfHeal()">Run Auto-Repair</button>
                        <div id="self-heal-output" class="progress-log" style="display:none;">
                            <div id="self-heal-log"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h5>System Diagnostics</h5>
                        <button class="btn btn-info mb-3" onclick="runDiagnostics()">Run Diagnostics</button>
                        <div id="diagnostics-output" class="progress-log" style="display:none;">
                            <div id="diagnostics-log"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Application Logs</h5>
                        <button class="btn btn-info mb-3" onclick="fetchLogs()">Fetch Latest Logs</button>
                        <div id="logs-output" class="progress-log" style="display:none;">
                            <div id="logs-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USERS TAB -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <h5>User Management</h5>

                <!-- Create User Form -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Create New User</h6>
                        <form id="create-user-form" class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="new-username" placeholder="Username" required>
                            </div>
                            <div class="col-md-4">
                                <input type="password" class="form-control" id="new-password" placeholder="Password" required>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="new-is-admin">
                                    <label class="form-check-label" for="new-is-admin">Admin</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">Create User</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Seed Test Users -->
                <div class="mb-3">
                    <button class="btn btn-secondary" onclick="seedTestUsers()">Seed 3 Test Users</button>
                    <span class="text-muted ms-2"><small>(usernames: testuser1, testuser2, testuser3 | password: test123)</small></span>
                </div>

                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Admin</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</td>
                                <td>
                                    {% if user.username != 'admin' %}
                                        <button class="btn btn-warning btn-sm reset-password-btn" data-user-id="{{ user.id }}" data-username="{{ user.username }}">Reset Password</button>
                                        <button class="btn btn-danger btn-sm delete-user-btn" data-user-id="{{ user.id }}" data-username="{{ user.username }}">Delete</button>
                                    {% else %}
                                        <span class="text-muted">Admin (Protected)</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ABOUT TAB -->
            <div class="tab-pane fade" id="about" role="tabpanel">
                <h5>About Project Content</h5>
                <p class="text-muted">Edit the content that appears on the public "About" page/popup. Supports Markdown.</p>

                <button class="btn btn-info mb-3" onclick="loadAboutContent()">Load Content</button>
                <button class="btn btn-success mb-3" onclick="saveAboutContent()">Save Content</button>

                <div class="mb-3">
                    <textarea class="form-control bg-dark text-light" id="about-content-editor" rows="20" placeholder="Enter About content here (Markdown supported)..."></textarea>
                </div>

                <div id="about-message" class="mt-3"></div>
            </div>

        </div>
    </main>

    <!-- Password Reset Modal -->
    <div class="modal fade" id="passwordResetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Reset Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Reset password for user: <strong id="reset-username"></strong></p>
                    <input type="hidden" id="reset-user-id">
                    <div class="mb-3">
                        <label for="reset-new-password" class="form-label">New Password</label>
                        <input type="password" class="form-control bg-dark text-light" id="reset-new-password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmPasswordReset()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}?v=3"></script>

</body>
</html>
